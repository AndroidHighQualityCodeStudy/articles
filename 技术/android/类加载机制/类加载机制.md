<a name="index">**目录**</a>

- <a href="#ch1">**1 Java 类加载过程**</a>

<br>
<br>

### <a name="ch1">1 Java 类加载过程</a><a style="float:right;text-decoration:none;" href="#index">[Top]</a>

通常，一个 Java 类被使用前，需要经过以下两个步骤：

1. 由 javac 编译成字节码。
2. 将代表该类的字节码文件加载到虚拟机。

Java 的一大魅力在于可以在运行时加载类。理论上，Java 虚拟机可以在应用程序运行过程中根据应用程序的执行要求加载任何一个合法的新类并执行。这体现了 Java 的动态性和灵活性。

我们可以试想一下 Java 类的加载过程：

首先，需要先将该类的字节码文件读到内存中；
其次，肯定需要对字节码进行一些验证，以确保它是合法并安全的，不会危害到系统，因为字节码并非只由 javac 编译 java 源程序得到，理论上只要遵循 java 字节码规范都可以得到一个虚拟机可执行的字节码文件；
然后，需要对这个类进行解析，即虚拟机需要知道这个类长什么样子，有些什么字段，需要分配多少内存，需要告诉应用程序如何才能调用到它；
最后，需要对该类进行一些必要的初始化工作，这种初始化的特点是只需要执行一次，因为类的加载一般也只需要执行一次，所以将这样的工作放到加载过程中是合理的。注意类的初始化不同于构造函数，确切地说，类的初始化是所有对象共有的部分，所以只会有一次，而构造函数应该是对象的初始化，不同的对象都要初始化一遍，所以并不属于类加载过程，从而也可以推断类的初始化应该是指的是静态初始化区域和静态字段。

以上是从正常的逻辑分析来看类的加载过程的，实际上，类的加载过程也大致如同上述所言，具体来看，如下图所示：

![Java class load process](images/class_load_process.png "Java class load process")

总体而言，类加载包括三个过程：加载、链接、初始化。其中，链接又包含验证、准备、解析三个阶段。一般而言，这几个过程的开始顺序是不变的，除了在 Java 动态绑定中解析在初始化之后以外。

简单介绍一下这几个过程的作用：

1. **加载**：将类的字节码二进制流读进内存；将该字节流代表的静态存储结构转化为方法区的运行时数据结构；在内存中生成一个代表这个类的 java.lang.Class 对象，作为方法区这个类的各种数据的访问入口。

2. **验证**：如前所述，验证阶段确实就是为了验证字节码的合法性和安全性。理论上用 javac 编译过后的字节码都应该符合虚拟机规范了，所以验证过程实际上可能重复做了很多在编译阶段已经做过的事情，但是由于字节码来源的多样性，这个验证阶段还是很重要的。验证过程包括验证字节码的格式、验证类的语义合法性、方法的语义合法性、代码的语义合法性等。

3. **准备**：准备阶段比较简单，就是给类的静态变量分配内存和赋初值。需要注意的是这里不同于类的初始化阶段给静态变量赋初值，准备阶段给静态变量赋的初值一般是零值，除非该静态变量用 final 进行修饰。

4. **解析**：解析阶段将常量池内的符号引用替换为直接引用。符号引用以一组符号来描述所引用的目标，符号可以是任何形式的字面量，只要使用时能无歧义地定位到目标即可；直接引用则是可以直接指向目标的指针、相对偏移量或者是一个能间接定位到目标的句柄。符号引用与直接引用的关系就好比姓名和身份证之间的关系一样。

5. **初始化**：
























































